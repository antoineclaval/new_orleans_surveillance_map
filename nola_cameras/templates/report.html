{% extends "base.html" %}

{% block title %}Report a Camera - New Orleans surveillance map{% endblock %}

{% block extra_css %}
<style>
    #location-map {
        height: 300px;
        width: 100%;
        border-radius: 0.5rem;
        cursor: crosshair;
    }

    .location-marker {
        background-color: #6b46c1;
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Report a Surveillance Camera</h1>
        <p class="text-gray-600">
            Help map surveillance cameras in New Orleans. Your submission will be reviewed before appearing on the map.
        </p>
    </div>

    <form method="post" enctype="multipart/form-data" class="space-y-6" x-data="reportForm()" @submit="validateForm($event)">
        {% csrf_token %}

        <!-- Honeypot field (hidden from users, catches bots) -->
        <div style="position: absolute; left: -9999px;" aria-hidden="true">
            {{ form.website }}
        </div>

        <!-- Location Map -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Camera Location <span class="text-red-500">*</span>
            </label>
            <div class="flex items-center gap-3 mb-2">
                <p class="text-sm text-gray-500"
                   x-text="latitude
                       ? 'Location set — drag the marker to adjust.'
                       : 'Click the map to set the camera location'"></p>
                <button type="button"
                        @click="useMyLocation()"
                        :disabled="locating"
                        class="flex items-center gap-1.5 text-sm px-3 py-1.5 rounded-lg border border-nola-purple text-nola-purple hover:bg-purple-50 transition disabled:opacity-50 disabled:cursor-not-allowed shrink-0">
                    <svg class="w-4 h-4" :class="{ 'animate-spin': locating }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span x-text="locating ? 'Detecting...' : 'Detect where I am'"></span>
                </button>
            </div>
            <p x-show="locationError" x-text="locationError" class="text-sm text-red-500 mb-2"></p>
            <div id="location-map" class="border border-gray-300"></div>
            <input type="hidden" name="latitude" x-model="latitude" id="id_latitude">
            <input type="hidden" name="longitude" x-model="longitude" id="id_longitude">
            <p x-show="!latitude" class="text-sm text-amber-600 mt-2">
                Please click on the map to select the camera location.
            </p>
            <p x-show="latitude" class="text-sm text-green-600 mt-2">
                Location selected: <span x-text="latitude?.toFixed(6)"></span>, <span x-text="longitude?.toFixed(6)"></span>
            </p>
        </div>

        <!-- Cross Road -->
        <div>
            <label for="id_cross_road" class="block text-sm font-medium text-gray-700 mb-2">
                Nearest Intersection <span class="text-red-500">*</span>
            </label>
            <input type="text"
                   name="cross_road"
                   id="id_cross_road"
                   required
                   class="form-input"
                   placeholder="e.g., Canal St & Bourbon St">
            {% if form.cross_road.errors %}
            <p class="text-sm text-red-500 mt-1">{{ form.cross_road.errors.0 }}</p>
            {% endif %}
        </div>

        <!-- Street Address -->
        <div>
            <label for="id_street_address" class="block text-sm font-medium text-gray-700 mb-2">
                Street Address <span class="text-gray-400">(optional)</span>
            </label>
            <input type="text"
                   name="street_address"
                   id="id_street_address"
                   class="form-input"
                   placeholder="e.g., 123 Main St">
        </div>

        <!-- Facial Recognition -->
        <div class="flex items-start">
            <div class="flex items-center h-5">
                <input type="checkbox"
                       name="facial_recognition"
                       id="id_facial_recognition"
                       class="form-checkbox">
            </div>
            <div class="ml-3">
                <label for="id_facial_recognition" class="text-sm font-medium text-gray-700">
                    Facial Recognition Capability
                </label>
                <p class="text-sm text-gray-500">Check if you believe this camera has facial recognition technology</p>
            </div>
        </div>

        <!-- Associated Shop -->
        <div>
            <label for="id_associated_shop" class="block text-sm font-medium text-gray-700 mb-2">
                Associated Business <span class="text-gray-400">(optional)</span>
            </label>
            <input type="text"
                   name="associated_shop"
                   id="id_associated_shop"
                   class="form-input"
                   placeholder="e.g., Corner Store">
            <p class="text-sm text-gray-500 mt-1">If this is a private camera, enter the business name</p>
        </div>

        <!-- Photo 1: Close-up of the camera -->
        <div>
            <label for="id_image" class="block text-sm font-medium text-gray-700 mb-2">
                Photo 1 — Close-up of the camera <span class="text-gray-400">(optional)</span>
            </label>
            <input type="file"
                   name="image"
                   id="id_image"
                   accept="image/*"
                   class="form-file"
                   @change="previewImage($event, 1)">
            <p class="text-sm text-gray-500 mt-1">A clear close-up photo of the camera itself</p>
            <div x-show="imagePreview" class="mt-3">
                <img :src="imagePreview" alt="Preview" class="max-h-48 rounded-lg border border-gray-200">
                <button type="button"
                        @click="clearImage(1)"
                        class="mt-2 text-sm text-red-500 hover:text-red-700">
                    Remove image
                </button>
            </div>
        </div>

        <!-- Photo 2: Camera and surroundings -->
        <div>
            <label for="id_image_2" class="block text-sm font-medium text-gray-700 mb-2">
                Photo 2 — Camera and surroundings <span class="text-gray-400">(optional)</span>
            </label>
            <input type="file"
                   name="image_2"
                   id="id_image_2"
                   accept="image/*"
                   class="form-file"
                   @change="previewImage($event, 2)">
            <p class="text-sm text-gray-500 mt-1">A wider shot showing the camera in its environment</p>
            <div x-show="imagePreview2" class="mt-3">
                <img :src="imagePreview2" alt="Preview" class="max-h-48 rounded-lg border border-gray-200">
                <button type="button"
                        @click="clearImage(2)"
                        class="mt-2 text-sm text-red-500 hover:text-red-700">
                    Remove image
                </button>
            </div>
        </div>

        <!-- Photo 3: Project Nola sign -->
        <div>
            <label for="id_image_3" class="block text-sm font-medium text-gray-700 mb-2">
                Photo 3 — Project Nola sign <span class="text-gray-400">(optional)</span>
            </label>
            <input type="file"
                   name="image_3"
                   id="id_image_3"
                   accept="image/*"
                   class="form-file"
                   @change="previewImage($event, 3)">
            <p class="text-sm text-gray-500 mt-1">A photo of a Project Nola sign, if present</p>
            <div x-show="imagePreview3" class="mt-3">
                <img :src="imagePreview3" alt="Preview" class="max-h-48 rounded-lg border border-gray-200">
                <button type="button"
                        @click="clearImage(3)"
                        class="mt-2 text-sm text-red-500 hover:text-red-700">
                    Remove image
                </button>
            </div>
        </div>

        <!-- Reporter Info -->
        <div>
            <label for="id_reported_by" class="block text-sm font-medium text-gray-700 mb-2">
                Your Email or Name <span class="text-gray-400">(optional)</span>
            </label>
            <input type="text"
                   name="reported_by"
                   id="id_reported_by"
                   class="form-input"
                   placeholder="e.g., john@example.com">
            <p class="text-sm text-gray-500 mt-1">This helps us contact you if we have questions</p>
        </div>

        <!-- Form Errors -->
        {% if form.non_field_errors %}
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <p class="text-red-700">{{ form.non_field_errors.0 }}</p>
        </div>
        {% endif %}

        <!-- Submit Button -->
        <div class="pt-4">
            <button type="submit"
                    class="w-full bg-nola-purple text-white py-3 px-6 rounded-lg font-medium hover:bg-purple-700 transition flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
                <span>Submit Camera Report</span>
            </button>
        </div>

        <p class="text-center text-sm text-gray-500">
            By submitting, you confirm this information is accurate to the best of your knowledge.
        </p>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
const REPORT_MAP_CONFIG = {
    lat: {{ init_lat }},
    lng: {{ init_lng }},
    zoom: {{ init_zoom }},
    pinned: {{ pinned|yesno:"true,false" }}
};
</script>
<script>
function reportForm() {
    return {
        map: null,
        marker: null,
        latitude: null,
        longitude: null,
        imagePreview: null,
        imagePreview2: null,
        imagePreview3: null,
        locating: false,
        locationError: null,

        init() {
            const cfg = REPORT_MAP_CONFIG;
            this.map = L.map('location-map').setView([cfg.lat, cfg.lng], cfg.zoom);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(this.map);

            if (cfg.pinned) {
                this.setLocation(cfg.lat, cfg.lng);
            }

            // Click handler to set marker
            this.map.on('click', (e) => {
                this.setLocation(e.latlng.lat, e.latlng.lng);
            });

            // Add geolocation button
            const locateBtn = L.control({ position: 'topright' });
            locateBtn.onAdd = () => {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                div.innerHTML = `
                    <a href="#" title="Use my location" style="display: flex; align-items: center; justify-content: center; width: 34px; height: 34px;">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </a>
                `;
                div.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.useMyLocation();
                };
                return div;
            };
            locateBtn.addTo(this.map);
        },

        setLocation(lat, lng) {
            this.latitude = lat;
            this.longitude = lng;

            // Remove existing marker
            if (this.marker) {
                this.map.removeLayer(this.marker);
            }

            // Add new marker
            const icon = L.divIcon({
                className: 'location-marker',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            this.marker = L.marker([lat, lng], { icon: icon, draggable: true }).addTo(this.map);

            // Allow dragging to adjust position
            this.marker.on('dragend', (e) => {
                const pos = e.target.getLatLng();
                this.latitude = pos.lat;
                this.longitude = pos.lng;
            });
        },

        useMyLocation() {
            if (!('geolocation' in navigator)) {
                this.locationError = 'Geolocation is not supported by your browser.';
                return;
            }
            this.locating = true;
            this.locationError = null;
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    this.locating = false;
                    const { latitude, longitude } = position.coords;
                    this.map.setView([latitude, longitude], 17);
                    this.setLocation(latitude, longitude);
                },
                () => {
                    this.locating = false;
                    this.locationError = 'Unable to get your location. Enable location permissions or click the map.';
                }
            );
        },

        previewImage(event, slot) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (slot === 2) this.imagePreview2 = e.target.result;
                    else if (slot === 3) this.imagePreview3 = e.target.result;
                    else this.imagePreview = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        },

        clearImage(slot) {
            if (slot === 2) {
                this.imagePreview2 = null;
                document.getElementById('id_image_2').value = '';
            } else if (slot === 3) {
                this.imagePreview3 = null;
                document.getElementById('id_image_3').value = '';
            } else {
                this.imagePreview = null;
                document.getElementById('id_image').value = '';
            }
        },

        validateForm(event) {
            if (!this.latitude || !this.longitude) {
                event.preventDefault();
                alert('Please click on the map to set the camera location.');
                return false;
            }
            return true;
        }
    };
}

// Initialize map when Alpine is ready
document.addEventListener('alpine:init', () => {
    Alpine.data('reportForm', reportForm);
});

// Fallback initialization if Alpine already loaded
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const formEl = document.querySelector('[x-data="reportForm()"]');
        if (formEl && formEl.__x) {
            formEl.__x.$data.init();
        }
    }, 100);
});
</script>
{% endblock %}

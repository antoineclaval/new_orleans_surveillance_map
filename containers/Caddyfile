# Caddyfile for NOLA Camera Mapping
# Site address comes from CADDY_SITE (set in .env), which defaults to DOMAIN:
#   Domain:  don't set CADDY_SITE → Caddy uses DOMAIN and auto-provisions TLS
#   Bare IP: CADDY_SITE=http://1.2.3.4 → HTTP-only (Let's Encrypt can't issue certs for IPs)

{$CADDY_SITE:localhost} {
    # Enable compression
    encode gzip

    # Handle static files
    handle /static/* {
        root * /srv
        file_server
    }

    # Handle media files (uploaded images)
    handle /media/* {
        root * /srv
        file_server
    }

    # Proxy everything else to Django
    handle {
        reverse_proxy web:8000 {
            header_up X-Forwarded-Proto {scheme}
            header_up X-Real-IP {remote_host}
        }
    }

    # Logging
    log {
        output stdout
        format console
    }
}
